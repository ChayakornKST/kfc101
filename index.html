<!doctype html> .
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบจัดการตารางสอน</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    * {
      box-sizing: border-box;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="h-full flex flex-col"></div>
  <script>
    const defaultConfig = {
      background_color: "#e0f2fe",
      surface_color: "#ffffff",
      text_color: "#0c4a6e",
      primary_action_color: "#0284c7",
      secondary_action_color: "#38bdf8",
      font_family: "sans-serif",
      font_size: 16,
      app_title: "ระบบจัดการตารางสอน",
      subjects_title: "รายวิชา",
      teachers_title: "ครูผู้สอน",
      rooms_title: "ห้องเรียน",
      schedule_title: "ข้อมูลเวลา",
      students_title: "นักเรียน"
    };

    let allData = [];
    let currentTab = 'subjects';

    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        renderApp();
      }
    };

    async function initApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error("Failed to initialize data SDK");
        return;
      }

      await window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          const appTitle = document.getElementById('app-title');
          if (appTitle) {
            appTitle.textContent = config.app_title || defaultConfig.app_title;
            appTitle.style.color = config.text_color || defaultConfig.text_color;
            appTitle.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
            appTitle.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 1.75}px`;
          }

          const tabs = document.querySelectorAll('.tab-button');
          tabs.forEach(tab => {
            tab.style.color = config.text_color || defaultConfig.text_color;
            tab.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
            tab.style.fontSize = `${config.font_size || defaultConfig.font_size}px`;
            if (tab.classList.contains('active')) {
              tab.style.backgroundColor = config.primary_action_color || defaultConfig.primary_action_color;
              tab.style.color = config.surface_color || defaultConfig.surface_color;
            }
          });

          const sectionTitles = document.querySelectorAll('.section-title');
          sectionTitles.forEach((title, index) => {
            const titles = [
              config.subjects_title || defaultConfig.subjects_title,
              config.teachers_title || defaultConfig.teachers_title,
              config.rooms_title || defaultConfig.rooms_title,
              config.schedule_title || defaultConfig.schedule_title,
              config.students_title || defaultConfig.students_title
            ];
            if (title) {
              title.textContent = titles[index];
              title.style.color = config.text_color || defaultConfig.text_color;
              title.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
              title.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 1.5}px`;
            }
          });

          const cards = document.querySelectorAll('.data-card');
          cards.forEach(card => {
            card.style.backgroundColor = config.surface_color || defaultConfig.surface_color;
            card.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
            card.style.fontSize = `${config.font_size || defaultConfig.font_size}px`;
          });

          const labels = document.querySelectorAll('.form-label');
          labels.forEach(label => {
            label.style.color = config.text_color || defaultConfig.text_color;
            label.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
            label.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 0.875}px`;
          });

          const inputs = document.querySelectorAll('input, select, textarea');
          inputs.forEach(input => {
            input.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
            input.style.fontSize = `${config.font_size || defaultConfig.font_size}px`;
          });

          const primaryButtons = document.querySelectorAll('.btn-primary');
          primaryButtons.forEach(btn => {
            btn.style.backgroundColor = config.primary_action_color || defaultConfig.primary_action_color;
            btn.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
            btn.style.fontSize = `${config.font_size || defaultConfig.font_size}px`;
          });

          const secondaryButtons = document.querySelectorAll('.btn-secondary');
          secondaryButtons.forEach(btn => {
            btn.style.backgroundColor = config.secondary_action_color || defaultConfig.secondary_action_color;
            btn.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
            btn.style.fontSize = `${config.font_size || defaultConfig.font_size}px`;
          });

          document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
        },
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                window.elementSdk.config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.surface_color || defaultConfig.surface_color,
              set: (value) => {
                window.elementSdk.config.surface_color = value;
                window.elementSdk.setConfig({ surface_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                window.elementSdk.config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.primary_action_color || defaultConfig.primary_action_color,
              set: (value) => {
                window.elementSdk.config.primary_action_color = value;
                window.elementSdk.setConfig({ primary_action_color: value });
              }
            },
            {
              get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
              set: (value) => {
                window.elementSdk.config.secondary_action_color = value;
                window.elementSdk.setConfig({ secondary_action_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => window.elementSdk.config.font_family || defaultConfig.font_family,
            set: (value) => {
              window.elementSdk.config.font_family = value;
              window.elementSdk.setConfig({ font_family: value });
            }
          },
          fontSizeable: {
            get: () => window.elementSdk.config.font_size || defaultConfig.font_size,
            set: (value) => {
              window.elementSdk.config.font_size = value;
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ["app_title", config.app_title || defaultConfig.app_title],
          ["subjects_title", config.subjects_title || defaultConfig.subjects_title],
          ["teachers_title", config.teachers_title || defaultConfig.teachers_title],
          ["rooms_title", config.rooms_title || defaultConfig.rooms_title],
          ["schedule_title", config.schedule_title || defaultConfig.schedule_title],
          ["students_title", config.students_title || defaultConfig.students_title]
        ])
      });

      renderApp();
    }

    function renderApp() {
      const config = window.elementSdk?.config || defaultConfig;
      const app = document.getElementById('app');
      
      const subjects = allData.filter(item => item.type === 'subject');
      const teachers = allData.filter(item => item.type === 'teacher');
      const rooms = allData.filter(item => item.type === 'room');
      const schedules = allData.filter(item => item.type === 'schedule');
      const students = allData.filter(item => item.type === 'student');

      app.innerHTML = `
        <div class="h-full flex flex-col" style="background-color: ${config.background_color || defaultConfig.background_color};">
          <header class="p-6" style="background-color: ${config.surface_color || defaultConfig.surface_color}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h1 id="app-title" class="text-center font-bold" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 1.75}px;">
              ${config.app_title || defaultConfig.app_title}
            </h1>
          </header>

          <nav class="flex border-b overflow-x-auto" style="background-color: ${config.surface_color || defaultConfig.surface_color}; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <button class="tab-button flex-shrink-0 py-4 px-6 font-medium transition-all duration-300 hover:bg-opacity-80 ${currentTab === 'subjects' ? 'active' : ''}" 
                    onclick="switchTab('subjects')"
                    style="color: ${currentTab === 'subjects' ? (config.surface_color || defaultConfig.surface_color) : (config.text_color || defaultConfig.text_color)}; 
                           background-color: ${currentTab === 'subjects' ? (config.primary_action_color || defaultConfig.primary_action_color) : 'transparent'};
                           font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;
                           font-size: ${config.font_size || defaultConfig.font_size}px;
                           border-radius: 8px 8px 0 0;
                           position: relative;">
              📚 ${config.subjects_title || defaultConfig.subjects_title}
            </button>
            <button class="tab-button flex-shrink-0 py-4 px-6 font-medium transition-all duration-300 hover:bg-opacity-80 ${currentTab === 'teachers' ? 'active' : ''}" 
                    onclick="switchTab('teachers')"
                    style="color: ${currentTab === 'teachers' ? (config.surface_color || defaultConfig.surface_color) : (config.text_color || defaultConfig.text_color)}; 
                           background-color: ${currentTab === 'teachers' ? (config.primary_action_color || defaultConfig.primary_action_color) : 'transparent'};
                           font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;
                           font-size: ${config.font_size || defaultConfig.font_size}px;
                           border-radius: 8px 8px 0 0;
                           position: relative;">
              👨‍🏫 ${config.teachers_title || defaultConfig.teachers_title}
            </button>
            <button class="tab-button flex-shrink-0 py-4 px-6 font-medium transition-all duration-300 hover:bg-opacity-80 ${currentTab === 'rooms' ? 'active' : ''}" 
                    onclick="switchTab('rooms')"
                    style="color: ${currentTab === 'rooms' ? (config.surface_color || defaultConfig.surface_color) : (config.text_color || defaultConfig.text_color)}; 
                           background-color: ${currentTab === 'rooms' ? (config.primary_action_color || defaultConfig.primary_action_color) : 'transparent'};
                           font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;
                           font-size: ${config.font_size || defaultConfig.font_size}px;
                           border-radius: 8px 8px 0 0;
                           position: relative;">
              🏫 ${config.rooms_title || defaultConfig.rooms_title}
            </button>
            <button class="tab-button flex-shrink-0 py-4 px-6 font-medium transition-all duration-300 hover:bg-opacity-80 ${currentTab === 'schedules' ? 'active' : ''}" 
                    onclick="switchTab('schedules')"
                    style="color: ${currentTab === 'schedules' ? (config.surface_color || defaultConfig.surface_color) : (config.text_color || defaultConfig.text_color)}; 
                           background-color: ${currentTab === 'schedules' ? (config.primary_action_color || defaultConfig.primary_action_color) : 'transparent'};
                           font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;
                           font-size: ${config.font_size || defaultConfig.font_size}px;
                           border-radius: 8px 8px 0 0;
                           position: relative;">
              ⏰ ${config.schedule_title || defaultConfig.schedule_title}
            </button>
            <button class="tab-button flex-shrink-0 py-4 px-6 font-medium transition-all duration-300 hover:bg-opacity-80 ${currentTab === 'students' ? 'active' : ''}" 
                    onclick="switchTab('students')"
                    style="color: ${currentTab === 'students' ? (config.surface_color || defaultConfig.surface_color) : (config.text_color || defaultConfig.text_color)}; 
                           background-color: ${currentTab === 'students' ? (config.primary_action_color || defaultConfig.primary_action_color) : 'transparent'};
                           font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;
                           font-size: ${config.font_size || defaultConfig.font_size}px;
                           border-radius: 8px 8px 0 0;
                           position: relative;">
              🎓 ${config.students_title || defaultConfig.students_title}
            </button>
            <button class="tab-button flex-shrink-0 py-4 px-6 font-medium transition-all duration-300 hover:bg-opacity-80 ${currentTab === 'analytics' ? 'active' : ''}" 
                    onclick="switchTab('analytics')"
                    style="color: ${currentTab === 'analytics' ? (config.surface_color || defaultConfig.surface_color) : (config.text_color || defaultConfig.text_color)}; 
                           background-color: ${currentTab === 'analytics' ? (config.primary_action_color || defaultConfig.primary_action_color) : 'transparent'};
                           font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;
                           font-size: ${config.font_size || defaultConfig.font_size}px;
                           border-radius: 8px 8px 0 0;
                           position: relative;">
              📊 วิเคราะห์ข้อมูล
            </button>
          </nav>

          <main class="flex-1 overflow-auto p-6">
            <div id="tab-content">
              ${currentTab === 'subjects' ? renderSubjectsTab(subjects, config) : ''}
              ${currentTab === 'teachers' ? renderTeachersTab(teachers, config) : ''}
              ${currentTab === 'rooms' ? renderRoomsTab(rooms, config) : ''}
              ${currentTab === 'schedules' ? renderSchedulesTab(schedules, config) : ''}
              ${currentTab === 'students' ? renderStudentsTab(students, config) : ''}
              ${currentTab === 'analytics' ? renderAnalyticsTab(subjects, teachers, rooms, schedules, students, config) : ''}
            </div>
          </main>
        </div>
      `;
    }

    function renderSubjectsTab(subjects, config) {
      return `
        <div class="max-w-6xl mx-auto">
          <div class="mb-6 p-6 rounded-lg data-card" style="background-color: ${config.surface_color || defaultConfig.surface_color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 class="section-title font-bold mb-4" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 1.5}px;">
              เพิ่ม${config.subjects_title || defaultConfig.subjects_title}
            </h2>
            <form onsubmit="addSubject(event)" class="space-y-4">
              <div>
                <label for="subject-name" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  ชื่อวิชา
                </label>
                <input type="text" id="subject-name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                       style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
              </div>
              <div>
                <label for="subject-periods" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  จำนวนคาบ
                </label>
                <input type="number" id="subject-periods" required min="1" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                       style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
              </div>
              <button type="submit" class="btn-primary w-full py-3 rounded-lg text-white font-medium transition-opacity hover:opacity-90" 
                      style="background-color: ${config.primary_action_color || defaultConfig.primary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                เพิ่มรายวิชา
              </button>
            </form>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${subjects.map(subject => `
              <div class="data-card p-6 rounded-xl transform transition-all duration-300 hover:scale-105 hover:shadow-xl" 
                   style="background: linear-gradient(135deg, ${config.surface_color || defaultConfig.surface_color} 0%, rgba(255,255,255,0.9) 100%); 
                          box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
                          border: 1px solid rgba(0,0,0,0.05);
                          font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; 
                          font-size: ${config.font_size || defaultConfig.font_size}px;">
                <div class="flex items-center mb-3">
                  <div class="w-3 h-3 rounded-full mr-3" style="background-color: ${config.primary_action_color || defaultConfig.primary_action_color};"></div>
                  <h3 class="font-bold" style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.125}px;">
                    📚 ${subject.subjectName}
                  </h3>
                </div>
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                  <p style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.8;">
                    📊 จำนวนคาบ: <span class="font-semibold">${subject.periods}</span>
                  </p>
                </div>
                <button onclick="deleteItem('${subject.__backendId}')" 
                        class="btn-secondary w-full py-2 px-4 rounded-lg text-white transition-all duration-300 hover:shadow-lg transform hover:-translate-y-1" 
                        style="background: linear-gradient(135deg, ${config.secondary_action_color || defaultConfig.secondary_action_color} 0%, rgba(56, 189, 248, 0.8) 100%); 
                               font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; 
                               font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  🗑️ ลบรายวิชา
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderTeachersTab(teachers, config) {
      return `
        <div class="max-w-6xl mx-auto">
          <div class="mb-6 p-6 rounded-lg data-card" style="background-color: ${config.surface_color || defaultConfig.surface_color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 class="section-title font-bold mb-4" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 1.5}px;">
              เพิ่ม${config.teachers_title || defaultConfig.teachers_title}
            </h2>
            <form onsubmit="addTeacher(event)" class="space-y-4">
              <div>
                <label for="teacher-name" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  ชื่อครู
                </label>
                <input type="text" id="teacher-name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                       style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
              </div>
              <div>
                <label for="teacher-unavailable" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  เวลาไม่สะดวก
                </label>
                <input type="text" id="teacher-unavailable" placeholder="เช่น จันทร์ 13:00-15:00" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                       style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
              </div>
              <div>
                <label for="teacher-max-hours" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  ชั่วโมงสอนสูงสุด
                </label>
                <input type="number" id="teacher-max-hours" required min="1" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                       style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
              </div>
              <button type="submit" class="btn-primary w-full py-3 rounded-lg text-white font-medium transition-opacity hover:opacity-90" 
                      style="background-color: ${config.primary_action_color || defaultConfig.primary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                เพิ่มครูผู้สอน
              </button>
            </form>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${teachers.map(teacher => `
              <div class="data-card p-4 rounded-lg" style="background-color: ${config.surface_color || defaultConfig.surface_color}; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                <h3 class="font-bold mb-2" style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.125}px;">
                  ${teacher.teacherName}
                </h3>
                <p style="color: ${config.text_color || defaultConfig.text_color};">
                  เวลาไม่สะดวก: ${teacher.unavailableTime || '-'}
                </p>
                <p style="color: ${config.text_color || defaultConfig.text_color};">
                  ชั่วโมงสูงสุด: ${teacher.maxHours}
                </p>
                <button onclick="deleteItem('${teacher.__backendId}')" class="btn-secondary mt-3 px-4 py-2 rounded text-white transition-opacity hover:opacity-90" 
                        style="background-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  ลบ
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderRoomsTab(rooms, config) {
      return `
        <div class="max-w-6xl mx-auto">
          <div class="mb-6 p-6 rounded-lg data-card" style="background-color: ${config.surface_color || defaultConfig.surface_color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 class="section-title font-bold mb-4" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 1.5}px;">
              เพิ่ม${config.rooms_title || defaultConfig.rooms_title}
            </h2>
            <form onsubmit="addRoom(event)" class="space-y-4">
              <div>
                <label for="room-name" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  ชื่อห้อง
                </label>
                <input type="text" id="room-name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                       style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
              </div>
              <div>
                <label for="room-size" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  ขนาด (จำนวนที่นั่ง)
                </label>
                <input type="number" id="room-size" required min="1" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                       style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
              </div>
              <div>
                <label for="room-type" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  ประเภท
                </label>
                <select id="room-type" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                        style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                  <option value="ห้องเรียนทั่วไป">ห้องเรียนทั่วไป</option>
                  <option value="ห้องปฏิบัติการ">ห้องปฏิบัติการ</option>
                  <option value="ห้องคอมพิวเตอร์">ห้องคอมพิวเตอร์</option>
                  <option value="ห้องวิทยาศาสตร์">ห้องวิทยาศาสตร์</option>
                  <option value="ห้องดนตรี">ห้องดนตรี</option>
                </select>
              </div>
              <button type="submit" class="btn-primary w-full py-3 rounded-lg text-white font-medium transition-opacity hover:opacity-90" 
                      style="background-color: ${config.primary_action_color || defaultConfig.primary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                เพิ่มห้องเรียน
              </button>
            </form>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${rooms.map(room => `
              <div class="data-card p-4 rounded-lg" style="background-color: ${config.surface_color || defaultConfig.surface_color}; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                <h3 class="font-bold mb-2" style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.125}px;">
                  ${room.roomName}
                </h3>
                <p style="color: ${config.text_color || defaultConfig.text_color};">
                  ขนาด: ${room.roomSize} ที่นั่ง
                </p>
                <p style="color: ${config.text_color || defaultConfig.text_color};">
                  ประเภท: ${room.roomType}
                </p>
                <button onclick="deleteItem('${room.__backendId}')" class="btn-secondary mt-3 px-4 py-2 rounded text-white transition-opacity hover:opacity-90" 
                        style="background-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  ลบ
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderSchedulesTab(schedules, config) {
      return `
        <div class="max-w-6xl mx-auto">
          <div class="mb-6 p-6 rounded-lg data-card" style="background-color: ${config.surface_color || defaultConfig.surface_color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 class="section-title font-bold mb-4" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 1.5}px;">
              เพิ่ม${config.schedule_title || defaultConfig.schedule_title}
            </h2>
            <form onsubmit="addSchedule(event)" class="space-y-4">
              <div>
                <label for="schedule-day" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  วัน
                </label>
                <select id="schedule-day" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                        style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                  <option value="จันทร์">จันทร์</option>
                  <option value="อังคาร">อังคาร</option>
                  <option value="พุธ">พุธ</option>
                  <option value="พฤหัสบดี">พฤหัสบดี</option>
                  <option value="ศุกร์">ศุกร์</option>
                </select>
              </div>
              <div>
                <label for="schedule-period" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  คาบที่
                </label>
                <input type="number" id="schedule-period" required min="1" max="10" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                       style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
              </div>
              <div>
                <label for="schedule-start" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  เวลาเริ่ม
                </label>
                <input type="time" id="schedule-start" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                       style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
              </div>
              <div>
                <label for="schedule-end" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  เวลาสิ้นสุด
                </label>
                <input type="time" id="schedule-end" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                       style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
              </div>
              <button type="submit" class="btn-primary w-full py-3 rounded-lg text-white font-medium transition-opacity hover:opacity-90" 
                      style="background-color: ${config.primary_action_color || defaultConfig.primary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                เพิ่มข้อมูลเวลา
              </button>
            </form>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${schedules.map(schedule => `
              <div class="data-card p-4 rounded-lg" style="background-color: ${config.surface_color || defaultConfig.surface_color}; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                <h3 class="font-bold mb-2" style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.125}px;">
                  ${schedule.dayName} - คาบที่ ${schedule.periodNumber}
                </h3>
                <p style="color: ${config.text_color || defaultConfig.text_color};">
                  เวลา: ${schedule.startTime} - ${schedule.endTime}
                </p>
                <button onclick="deleteItem('${schedule.__backendId}')" class="btn-secondary mt-3 px-4 py-2 rounded text-white transition-opacity hover:opacity-90" 
                        style="background-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  ลบ
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderStudentsTab(students, config) {
      return `
        <div class="max-w-6xl mx-auto">
          <div class="mb-6 p-6 rounded-lg data-card" style="background-color: ${config.surface_color || defaultConfig.surface_color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 class="section-title font-bold mb-4" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 1.5}px;">
              เพิ่ม${config.students_title || defaultConfig.students_title}
            </h2>
            <form onsubmit="addStudent(event)" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="student-name" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                    ชื่อนักเรียน
                  </label>
                  <input type="text" id="student-name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                         style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                </div>
                <div>
                  <label for="student-id" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                    รหัสประจำตัว
                  </label>
                  <input type="text" id="student-id" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                         style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label for="student-department" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                    แผนก
                  </label>
                  <select id="student-department" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                          style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                    <option value="วิทยาศาสตร์-คณิตศาสตร์">วิทยาศาสตร์-คณิตศาสตร์</option>
                    <option value="ภาษา-สังคม">ภาษา-สังคม</option>
                    <option value="ศิลป์-ภาษา">ศิลป์-ภาษา</option>
                    <option value="อาชีวศึกษา">อาชีวศึกษา</option>
                  </select>
                </div>
                <div>
                  <label for="student-grade" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                    ระดับชั้น
                  </label>
                  <select id="student-grade" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                          style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                    <option value="ม.1">ม.1</option>
                    <option value="ม.2">ม.2</option>
                    <option value="ม.3">ม.3</option>
                    <option value="ม.4">ม.4</option>
                    <option value="ม.5">ม.5</option>
                    <option value="ม.6">ม.6</option>
                  </select>
                </div>
                <div>
                  <label for="student-group" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                    กลุ่มเรียน
                  </label>
                  <input type="text" id="student-group" required placeholder="เช่น 1/1, 2/3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                         style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                </div>
              </div>
              <div>
                <label for="student-subjects" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  รายวิชาที่ลงทะเบียน
                </label>
                <textarea id="student-subjects" rows="3" placeholder="เช่น คณิตศาสตร์, ฟิสิกส์, เคมี" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                          style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;"></textarea>
              </div>
              <div>
                <label for="student-conditions" class="form-label block mb-2 font-medium" style="color: ${config.text_color || defaultConfig.text_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  เงื่อนไขพิเศษ
                </label>
                <textarea id="student-conditions" rows="2" placeholder="เช่น กลุ่มเรียนคู่ขนาน, ต้องเรียนพร้อมกัน" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2" 
                          style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;"></textarea>
              </div>
              <button type="submit" class="btn-primary w-full py-3 rounded-lg text-white font-medium transition-opacity hover:opacity-90" 
                      style="background-color: ${config.primary_action_color || defaultConfig.primary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                เพิ่มนักเรียน
              </button>
            </form>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${students.map(student => `
              <div class="data-card p-4 rounded-lg" style="background-color: ${config.surface_color || defaultConfig.surface_color}; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${config.font_size || defaultConfig.font_size}px;">
                <h3 class="font-bold mb-2" style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.125}px;">
                  ${student.studentName}
                </h3>
                <p style="color: ${config.text_color || defaultConfig.text_color};">
                  รหัส: ${student.studentId}
                </p>
                <p style="color: ${config.text_color || defaultConfig.text_color};">
                  ${student.department} ${student.grade} ห้อง ${student.group}
                </p>
                <p style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  วิชา: ${student.registeredSubjects || '-'}
                </p>
                ${student.specialConditions ? `
                  <p style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                    เงื่อนไข: ${student.specialConditions}
                  </p>
                ` : ''}
                <button onclick="deleteItem('${student.__backendId}')" class="btn-secondary mt-3 px-4 py-2 rounded text-white transition-opacity hover:opacity-90" 
                        style="background-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; font-family: ${config.font_family || defaultConfig.font_family}, sans-serif; font-size: ${(config.font_size || defaultConfig.font_size) * 0.875}px;">
                  ลบ
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }



    window.switchTab = function(tab) {
      currentTab = tab;
      renderApp();
    };

    window.addSubject = async function(event) {
      event.preventDefault();
      
      if (allData.length >= 999) {
        showMessage('ถึงขีดจำกัด 999 รายการแล้ว กรุณาลบรายการบางส่วนก่อน');
        return;
      }

      const name = document.getElementById('subject-name').value;
      const periods = parseInt(document.getElementById('subject-periods').value);

      const button = event.target.querySelector('button[type="submit"]');
      button.disabled = true;
      button.textContent = 'กำลังเพิ่ม...';

      const result = await window.dataSdk.create({
        type: 'subject',
        subjectName: name,
        periods: periods,
        createdAt: new Date().toISOString()
      });

      button.disabled = false;
      button.textContent = 'เพิ่มรายวิชา';

      if (result.isOk) {
        event.target.reset();
        showMessage('เพิ่มรายวิชาสำเร็จ');
      } else {
        showMessage('เกิดข้อผิดพลาด: ' + result.error.message);
      }
    };

    window.addTeacher = async function(event) {
      event.preventDefault();
      
      if (allData.length >= 999) {
        showMessage('ถึงขีดจำกัด 999 รายการแล้ว กรุณาลบรายการบางส่วนก่อน');
        return;
      }

      const name = document.getElementById('teacher-name').value;
      const unavailable = document.getElementById('teacher-unavailable').value;
      const maxHours = parseInt(document.getElementById('teacher-max-hours').value);

      const button = event.target.querySelector('button[type="submit"]');
      button.disabled = true;
      button.textContent = 'กำลังเพิ่ม...';

      const result = await window.dataSdk.create({
        type: 'teacher',
        teacherName: name,
        unavailableTime: unavailable,
        maxHours: maxHours,
        createdAt: new Date().toISOString()
      });

      button.disabled = false;
      button.textContent = 'เพิ่มครูผู้สอน';

      if (result.isOk) {
        event.target.reset();
        showMessage('เพิ่มครูผู้สอนสำเร็จ');
      } else {
        showMessage('เกิดข้อผิดพลาด: ' + result.error.message);
      }
    };

    window.addRoom = async function(event) {
      event.preventDefault();
      
      if (allData.length >= 999) {
        showMessage('ถึงขีดจำกัด 999 รายการแล้ว กรุณาลบรายการบางส่วนก่อน');
        return;
      }

      const name = document.getElementById('room-name').value;
      const size = parseInt(document.getElementById('room-size').value);
      const type = document.getElementById('room-type').value;

      const button = event.target.querySelector('button[type="submit"]');
      button.disabled = true;
      button.textContent = 'กำลังเพิ่ม...';

      const result = await window.dataSdk.create({
        type: 'room',
        roomName: name,
        roomSize: size,
        roomType: type,
        createdAt: new Date().toISOString()
      });

      button.disabled = false;
      button.textContent = 'เพิ่มห้องเรียน';

      if (result.isOk) {
        event.target.reset();
        showMessage('เพิ่มห้องเรียนสำเร็จ');
      } else {
        showMessage('เกิดข้อผิดพลาด: ' + result.error.message);
      }
    };

    window.addSchedule = async function(event) {
      event.preventDefault();
      
      if (allData.length >= 999) {
        showMessage('ถึงขีดจำกัด 999 รายการแล้ว กรุณาลบรายการบางส่วนก่อน');
        return;
      }

      const day = document.getElementById('schedule-day').value;
      const period = parseInt(document.getElementById('schedule-period').value);
      const start = document.getElementById('schedule-start').value;
      const end = document.getElementById('schedule-end').value;

      const button = event.target.querySelector('button[type="submit"]');
      button.disabled = true;
      button.textContent = 'กำลังเพิ่ม...';

      const result = await window.dataSdk.create({
        type: 'schedule',
        dayName: day,
        periodNumber: period,
        startTime: start,
        endTime: end,
        createdAt: new Date().toISOString()
      });

      button.disabled = false;
      button.textContent = 'เพิ่มข้อมูลเวลา';

      if (result.isOk) {
        event.target.reset();
        showMessage('เพิ่มข้อมูลเวลาสำเร็จ');
      } else {
        showMessage('เกิดข้อผิดพลาด: ' + result.error.message);
      }
    };

    window.addStudent = async function(event) {
      event.preventDefault();
      
      if (allData.length >= 999) {
        showMessage('ถึงขีดจำกัด 999 รายการแล้ว กรุณาลบรายการบางส่วนก่อน');
        return;
      }

      const name = document.getElementById('student-name').value;
      const id = document.getElementById('student-id').value;
      const department = document.getElementById('student-department').value;
      const grade = document.getElementById('student-grade').value;
      const group = document.getElementById('student-group').value;
      const subjects = document.getElementById('student-subjects').value;
      const conditions = document.getElementById('student-conditions').value;

      const button = event.target.querySelector('button[type="submit"]');
      button.disabled = true;
      button.textContent = 'กำลังเพิ่ม...';

      const result = await window.dataSdk.create({
        type: 'student',
        studentName: name,
        studentId: id,
        department: department,
        grade: grade,
        group: group,
        registeredSubjects: subjects,
        specialConditions: conditions,
        createdAt: new Date().toISOString()
      });

      button.disabled = false;
      button.textContent = 'เพิ่มนักเรียน';

      if (result.isOk) {
        event.target.reset();
        showMessage('เพิ่มนักเรียนสำเร็จ');
      } else {
        showMessage('เกิดข้อผิดพลาด: ' + result.error.message);
      }
    };



    window.deleteItem = async function(backendId) {
      const item = allData.find(d => d.__backendId === backendId);
      if (!item) return;

      const deleteButton = event.target;
      const originalText = deleteButton.textContent;
      deleteButton.disabled = true;
      deleteButton.textContent = 'กำลังลบ...';

      const result = await window.dataSdk.delete(item);

      if (result.isOk) {
        showMessage('ลบข้อมูลสำเร็จ');
      } else {
        deleteButton.disabled = false;
        deleteButton.textContent = originalText;
        showMessage('เกิดข้อผิดพลาด: ' + result.error.message);
      }
    };

    function renderAnalyticsTab(subjects, teachers, rooms, schedules, students, config) {
      // คำนวณสถิติต่างๆ
      const totalSubjects = subjects.length;
      const totalTeachers = teachers.length;
      const totalRooms = rooms.length;
      const totalStudents = students.length;
      const totalPeriods = subjects.reduce((sum, subject) => sum + subject.periods, 0);
      
      // วิเคราะห์ประเภทห้องเรียน
      const roomTypes = {};
      rooms.forEach(room => {
        roomTypes[room.roomType] = (roomTypes[room.roomType] || 0) + 1;
      });
      
      // วิเคราะห์แผนกนักเรียน
      const departments = {};
      students.forEach(student => {
        departments[student.department] = (departments[student.department] || 0) + 1;
      });
      
      // วิเคราะห์ระดับชั้น
      const grades = {};
      students.forEach(student => {
        grades[student.grade] = (grades[student.grade] || 0) + 1;
      });

      return `
        <div class="max-w-7xl mx-auto space-y-8">
          <!-- สถิติรวม -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="stat-card p-6 rounded-xl text-center transform transition-all duration-300 hover:scale-105" 
                 style="background: linear-gradient(135deg, ${config.primary_action_color || defaultConfig.primary_action_color} 0%, rgba(2, 132, 199, 0.8) 100%); 
                        color: white; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">
              <div class="text-4xl mb-2">📚</div>
              <div class="text-3xl font-bold mb-1">${totalSubjects}</div>
              <div class="text-sm opacity-90">รายวิชาทั้งหมด</div>
            </div>
            
            <div class="stat-card p-6 rounded-xl text-center transform transition-all duration-300 hover:scale-105" 
                 style="background: linear-gradient(135deg, ${config.secondary_action_color || defaultConfig.secondary_action_color} 0%, rgba(56, 189, 248, 0.8) 100%); 
                        color: white; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">
              <div class="text-4xl mb-2">👨‍🏫</div>
              <div class="text-3xl font-bold mb-1">${totalTeachers}</div>
              <div class="text-sm opacity-90">ครูผู้สอน</div>
            </div>
            
            <div class="stat-card p-6 rounded-xl text-center transform transition-all duration-300 hover:scale-105" 
                 style="background: linear-gradient(135deg, #10b981 0%, rgba(16, 185, 129, 0.8) 100%); 
                        color: white; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">
              <div class="text-4xl mb-2">🏫</div>
              <div class="text-3xl font-bold mb-1">${totalRooms}</div>
              <div class="text-sm opacity-90">ห้องเรียน</div>
            </div>
            
            <div class="stat-card p-6 rounded-xl text-center transform transition-all duration-300 hover:scale-105" 
                 style="background: linear-gradient(135deg, #f59e0b 0%, rgba(245, 158, 11, 0.8) 100%); 
                        color: white; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">
              <div class="text-4xl mb-2">🎓</div>
              <div class="text-3xl font-bold mb-1">${totalStudents}</div>
              <div class="text-sm opacity-90">นักเรียน</div>
            </div>
          </div>

          <!-- กราฟและการวิเคราะห์ -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- วิเคราะห์ประเภทห้องเรียน -->
            <div class="analysis-card p-6 rounded-xl" 
                 style="background-color: ${config.surface_color || defaultConfig.surface_color}; 
                        box-shadow: 0 8px 32px rgba(0,0,0,0.08); 
                        border: 1px solid rgba(0,0,0,0.05);">
              <h3 class="text-xl font-bold mb-4 flex items-center" 
                  style="color: ${config.text_color || defaultConfig.text_color};">
                🏫 การกระจายประเภทห้องเรียน
              </h3>
              <div class="space-y-3">
                ${Object.entries(roomTypes).map(([type, count]) => {
                  const percentage = ((count / totalRooms) * 100).toFixed(1);
                  return `
                    <div class="flex items-center justify-between">
                      <span style="color: ${config.text_color || defaultConfig.text_color};">${type}</span>
                      <div class="flex items-center space-x-2">
                        <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                          <div class="h-full rounded-full transition-all duration-500" 
                               style="width: ${percentage}%; background-color: ${config.primary_action_color || defaultConfig.primary_action_color};"></div>
                        </div>
                        <span class="text-sm font-semibold" style="color: ${config.text_color || defaultConfig.text_color};">${count} (${percentage}%)</span>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>

            <!-- วิเคราะห์แผนกนักเรียน -->
            <div class="analysis-card p-6 rounded-xl" 
                 style="background-color: ${config.surface_color || defaultConfig.surface_color}; 
                        box-shadow: 0 8px 32px rgba(0,0,0,0.08); 
                        border: 1px solid rgba(0,0,0,0.05);">
              <h3 class="text-xl font-bold mb-4 flex items-center" 
                  style="color: ${config.text_color || defaultConfig.text_color};">
                🎓 การกระจายแผนกนักเรียน
              </h3>
              <div class="space-y-3">
                ${Object.entries(departments).map(([dept, count]) => {
                  const percentage = ((count / totalStudents) * 100).toFixed(1);
                  return `
                    <div class="flex items-center justify-between">
                      <span style="color: ${config.text_color || defaultConfig.text_color};">${dept}</span>
                      <div class="flex items-center space-x-2">
                        <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                          <div class="h-full rounded-full transition-all duration-500" 
                               style="width: ${percentage}%; background-color: ${config.secondary_action_color || defaultConfig.secondary_action_color};"></div>
                        </div>
                        <span class="text-sm font-semibold" style="color: ${config.text_color || defaultConfig.text_color};">${count} (${percentage}%)</span>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>

          <!-- ข้อมูลเชิงลึก -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="insight-card p-6 rounded-xl" 
                 style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%); 
                        border: 1px solid rgba(139, 92, 246, 0.2); 
                        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.1);">
              <div class="text-center">
                <div class="text-3xl mb-2">⏱️</div>
                <div class="text-2xl font-bold mb-1" style="color: ${config.text_color || defaultConfig.text_color};">${totalPeriods}</div>
                <div class="text-sm" style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.7;">คาบเรียนทั้งหมด</div>
              </div>
            </div>
            
            <div class="insight-card p-6 rounded-xl" 
                 style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(236, 72, 153, 0.05) 100%); 
                        border: 1px solid rgba(236, 72, 153, 0.2); 
                        box-shadow: 0 4px 20px rgba(236, 72, 153, 0.1);">
              <div class="text-center">
                <div class="text-3xl mb-2">📊</div>
                <div class="text-2xl font-bold mb-1" style="color: ${config.text_color || defaultConfig.text_color};">${(totalPeriods / Math.max(totalTeachers, 1)).toFixed(1)}</div>
                <div class="text-sm" style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.7;">คาบเฉลี่ย/ครู</div>
              </div>
            </div>
            
            <div class="insight-card p-6 rounded-xl" 
                 style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%); 
                        border: 1px solid rgba(34, 197, 94, 0.2); 
                        box-shadow: 0 4px 20px rgba(34, 197, 94, 0.1);">
              <div class="text-center">
                <div class="text-3xl mb-2">🏫</div>
                <div class="text-2xl font-bold mb-1" style="color: ${config.text_color || defaultConfig.text_color};">${(totalStudents / Math.max(totalRooms, 1)).toFixed(1)}</div>
                <div class="text-sm" style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.7;">นักเรียนเฉลี่ย/ห้อง</div>
              </div>
            </div>
          </div>

          <!-- Python Code Simulation -->
          <div class="code-section p-6 rounded-xl" 
               style="background-color: #1e293b; color: #e2e8f0; font-family: 'Courier New', monospace;">
            <h3 class="text-lg font-bold mb-4 text-green-400">🐍 Python Data Analysis Simulation</h3>
            <div class="text-sm space-y-2">
              <div class="text-gray-400"># การวิเคราะห์ข้อมูลระบบจัดการตารางสอน</div>
              <div><span class="text-blue-400">import</span> <span class="text-yellow-400">pandas</span> <span class="text-blue-400">as</span> <span class="text-yellow-400">pd</span></div>
              <div><span class="text-blue-400">import</span> <span class="text-yellow-400">matplotlib.pyplot</span> <span class="text-blue-400">as</span> <span class="text-yellow-400">plt</span></div>
              <div class="mt-3">
                <div class="text-gray-400"># สร้าง DataFrame จากข้อมูล</div>
                <div><span class="text-yellow-400">data</span> = {</div>
                <div class="ml-4"><span class="text-green-300">'subjects'</span>: <span class="text-orange-400">${totalSubjects}</span>,</div>
                <div class="ml-4"><span class="text-green-300">'teachers'</span>: <span class="text-orange-400">${totalTeachers}</span>,</div>
                <div class="ml-4"><span class="text-green-300">'rooms'</span>: <span class="text-orange-400">${totalRooms}</span>,</div>
                <div class="ml-4"><span class="text-green-300">'students'</span>: <span class="text-orange-400">${totalStudents}</span></div>
                <div>}</div>
              </div>
              <div class="mt-3">
                <div class="text-gray-400"># คำนวณอัตราส่วน</div>
                <div><span class="text-yellow-400">ratio</span> = <span class="text-yellow-400">data</span>[<span class="text-green-300">'students'</span>] / <span class="text-yellow-400">data</span>[<span class="text-green-300">'rooms'</span>]</div>
                <div><span class="text-blue-400">print</span>(<span class="text-green-300">f"อัตราส่วนนักเรียน:ห้อง = {ratio:.1f}:1"</span>)</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function showMessage(message) {
      const config = window.elementSdk?.config || defaultConfig;
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: ${config.primary_action_color || defaultConfig.primary_action_color};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        font-family: ${config.font_family || defaultConfig.font_family}, sans-serif;
        font-size: ${config.font_size || defaultConfig.font_size}px;
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99708447c361a1b1',t:'MTc2MTg4NjA3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
